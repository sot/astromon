<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astromon.db &#8212; Astromon 1.3.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css?v=f4f7060c" />
    
    <script src="../../_static/documentation_options.js?v=bb516dca"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">Astromon</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">Astromon 1.3.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astromon.db</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tables</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cxotime</span><span class="w"> </span><span class="kn">import</span> <span class="n">CxoTime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mica.archive.obspar</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_obspar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ska_helpers.retry</span><span class="w"> </span><span class="kn">import</span> <span class="n">tables_open_file</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astromon</span><span class="w"> </span><span class="kn">import</span> <span class="n">observation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astromon.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingTableException</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;get_table&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_cross_matches&quot;</span><span class="p">,</span>
    <span class="s2">&quot;save&quot;</span><span class="p">,</span>
    <span class="s2">&quot;add_regions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;update_regions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;remove_regions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sync_regions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_regions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_in_excluded_region&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">if</span> <span class="s2">&quot;ASTROMON_FILE&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">FILE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ASTROMON_FILE&quot;</span><span class="p">])</span>
<span class="k">elif</span> <span class="s2">&quot;NO_DEFAULT_ASTROMON&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">FILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">FILE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SKA&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;astromon&quot;</span> <span class="o">/</span> <span class="s2">&quot;astromon.h5&quot;</span>

<span class="n">ASTROMON_XCORR_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;select_name&quot;</span><span class="p">,</span> <span class="s2">&quot;S14&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;c_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;x_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dz&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dr&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">ASTROMON_XRAY_SRC_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;net_counts&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;y_angle&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_angle&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;r_angle&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;snr&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;near_neighbor_dist&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;acis_streak&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;caldb_version&quot;</span><span class="p">,</span> <span class="s2">&quot;S10&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">ASTROMON_CAT_SRC_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;x_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;S16&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;S24&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;separation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;y_angle&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;z_angle&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">ASTROMON_OBS_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;detector&quot;</span><span class="p">,</span> <span class="s2">&quot;S6&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;S28&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;grating&quot;</span><span class="p">,</span> <span class="s2">&quot;S4&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sim_z&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;date_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;S20&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;tstart&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ascdsver&quot;</span><span class="p">,</span> <span class="s2">&quot;S32&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;category_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">ASTROMON_REGION_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;region_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">,</span> <span class="s2">&quot;S10&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;last_modified&quot;</span><span class="p">,</span> <span class="s2">&quot;S21&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;S50&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">,</span> <span class="s2">&quot;S200&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">ASTROMON_META_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;last_region_id&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">DTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;astromon_xcorr&quot;</span><span class="p">:</span> <span class="n">ASTROMON_XCORR_DTYPE</span><span class="p">,</span>
    <span class="s2">&quot;astromon_xray_src&quot;</span><span class="p">:</span> <span class="n">ASTROMON_XRAY_SRC_DTYPE</span><span class="p">,</span>
    <span class="s2">&quot;astromon_cat_src&quot;</span><span class="p">:</span> <span class="n">ASTROMON_CAT_SRC_DTYPE</span><span class="p">,</span>
    <span class="s2">&quot;astromon_obs&quot;</span><span class="p">:</span> <span class="n">ASTROMON_OBS_DTYPE</span><span class="p">,</span>
    <span class="s2">&quot;astromon_regions&quot;</span><span class="p">:</span> <span class="n">ASTROMON_REGION_DTYPE</span><span class="p">,</span>
    <span class="s2">&quot;astromon_meta&quot;</span><span class="p">:</span> <span class="n">ASTROMON_META_DTYPE</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an empty table using standard dtypes.</span>

<span class="sd">    Known table names:</span>

<span class="sd">    - astromon_xcorr</span>
<span class="sd">    - astromon_xray_src</span>
<span class="sd">    - astromon_cat_src</span>
<span class="sd">    - astromon_obs</span>
<span class="sd">    - astromon_regions</span>
<span class="sd">    - astromon_meta</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table_name: str</span>
<span class="sd">        Name of the table to retrieve, which specifies the dtype.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :any:`astropy.table.Table`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">DTYPES</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPES</span><span class="p">[</span><span class="n">table_name</span><span class="p">])</span>


<div class="viewcode-block" id="get_table">
<a class="viewcode-back" href="../../api.html#astromon.db.get_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an entire table from the DB file.</span>

<span class="sd">    Known table names:</span>

<span class="sd">    - astromon_xcorr</span>
<span class="sd">    - astromon_xray_src</span>
<span class="sd">    - astromon_cat_src</span>
<span class="sd">    - astromon_obs</span>
<span class="sd">    - astromon_regions</span>
<span class="sd">    - astromon_meta</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table_name: str</span>
<span class="sd">        Name of the table to retrieve. If the requested table is not in the file,</span>
<span class="sd">        an exception will be raised.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :any:`astropy.table.Table`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># logger = logging.getLogger(&#39;astromon&#39;)</span>
    <span class="c1"># if not Path(dbfile).exists():</span>
    <span class="c1">#     raise RuntimeError(f&#39;Astromon DB file does not exist {dbfile}&#39;)</span>

    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[:]</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">DTYPES</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DTYPES</span><span class="p">[</span><span class="n">table_name</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">convert_bytestring_to_unicode</span><span class="p">()</span>
            <span class="n">set_formats</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;obsid&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="k">raise</span> <span class="n">MissingTableException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> not in file. Available tables: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="k">return</span> <span class="n">result</span></div>



<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that returns a DB connection (or an HDF5 file).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :any:`tables.File &lt;tables.file.File&gt;` or :any:`sqlite3.Connection`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dbfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">FILE</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">tables</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">dbfile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;astromon&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dbfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">FILE</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dbfile</span><span class="p">))</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r+&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dbfile</span><span class="si">}</span><span class="s2"> open&quot;</span><span class="p">)</span>
        <span class="n">h5</span> <span class="o">=</span> <span class="n">tables_open_file</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">h5</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h5</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
                <span class="n">h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dbfile</span><span class="si">}</span><span class="s2"> closed (1)&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h5</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
                <span class="n">h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dbfile</span><span class="si">}</span><span class="s2"> closed (2)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="save">
<a class="viewcode-back" href="../../api.html#astromon.db.save">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">ignore_obsid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert data into a table, deleting previous entries for the same OBSID.</span>

<span class="sd">    If the table does not exist, it is created using pre-existing table definitions.</span>

<span class="sd">    If `ignore_obsid` is `False`, and `data` has an &quot;obsid&quot; column, this function replaces all rows</span>
<span class="sd">    in the table whose OBSID is in `data[&quot;obsid&quot;]`. It does not replace the whole table. If `data`</span>
<span class="sd">    has all rows of a given obsid removed, those entries are NOT removed from the table. For</span>
<span class="sd">    example, the following code has no effect:</span>

<span class="sd">        data = db.get_table(&quot;astromon_xray_src&quot;, dbfile)</span>
<span class="sd">        data = data[data[&#39;obsid&#39;] != 12345]</span>
<span class="sd">        db.save(&quot;astromon_xray_src&quot;, data, dbfile)</span>

<span class="sd">    To remove all entries for a given obsid, set `ignore_obsid=True`. If you do that,</span>
<span class="sd">    the entire table is replaced by `data`. The following removes all entries for obsid 12345:</span>

<span class="sd">        data = db.get_table(&quot;astromon_xray_src&quot;, dbfile)</span>
<span class="sd">        data = data[data[&#39;obsid&#39;] != 12345]</span>
<span class="sd">        db.save(&quot;astromon_xray_src&quot;, data, dbfile, ignore_obsid=True)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table_name: str</span>
<span class="sd">        The name of the table.</span>
<span class="sd">    data: :any:`astropy.table.Table`</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    ignore_obsid: bool</span>
<span class="sd">        If True, do not consider obsid to decide which rows to keep in the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h5</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h5</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is not open&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h5</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h5</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is not open for writing&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;input to _save_hdf5 must be a table&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">DTYPES</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">DTYPES</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Input data has no columns in common with table in DB&quot;</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Saving table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> with missing columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">b</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="n">names</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_obsid</span> <span class="ow">and</span> <span class="s2">&quot;obsid&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="c1"># remove rows for these obsids</span>
                <span class="n">obsids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">])</span>
                <span class="n">data_out</span> <span class="o">=</span> <span class="n">node</span><span class="p">[:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">data_out</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data_out</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">],</span> <span class="n">obsids</span><span class="p">)]</span>
                <span class="c1"># append current data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_out</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
            <span class="n">h5</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_regions">
<a class="viewcode-back" href="../../api.html#astromon.db.remove_regions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove exclusion regions (by ID) from the astromon_regions table.</span>

<span class="sd">    Raises an exception if the astromon_regions table is not in the dbfile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regions: list</span>
<span class="sd">        list of integer region ID.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">all_regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_regions</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">],</span> <span class="n">regions</span><span class="p">)</span>
        <span class="n">all_regions</span> <span class="o">=</span> <span class="n">all_regions</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>

        <span class="c1"># We just removed some regions. In the process, maybe all rows for a given obsid were</span>
        <span class="c1"># removed. In the following, if ignore_obsids is False, these rows would not be removed.</span>
        <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">all_regions</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">,</span> <span class="n">ignore_obsid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_regions">
<a class="viewcode-back" href="../../api.html#astromon.db.add_regions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add exclusion regions to the astromon_regions table.</span>

<span class="sd">    A unique region ID is automatically generated.</span>
<span class="sd">    Raises an exception if the astromon_regions table is not in the dbfile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regions: `astropy.table.Table`-compatible</span>
<span class="sd">        This parameter gets converted to an `astropy.table.Table`.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;astromon&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding regions: </span><span class="si">{</span><span class="n">regions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">all_regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;astromon_meta&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">astromon_meta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">astromon_meta</span><span class="p">[:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPES</span><span class="p">[</span><span class="s2">&quot;astromon_meta&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPES</span><span class="p">[</span><span class="s2">&quot;astromon_meta&quot;</span><span class="p">]))</span>

        <span class="n">rid</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;last_region_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_regions</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">regions</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">all_regions</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">b</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">all_regions</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">names</span><span class="p">])</span>
        <span class="n">b</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">rid</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">b</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span>
        <span class="c1"># we need to ensure region_id_str are unique. Using the auto-incrementing region_id does</span>
        <span class="c1"># not work when we want to synchronize two or more DBs, because adding different regions</span>
        <span class="c1"># to each DB could generate the same region_id and cause a collision when syncing.</span>
        <span class="c1"># With a 40-bit random number/string, the probability of collision is less than 10^9.</span>
        <span class="n">region_id_str</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">b</span>
        <span class="p">]</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sel</span> <span class="o">:=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">region_id_str</span><span class="p">,</span> <span class="n">all_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">])):</span>
            <span class="n">region_id_str</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">region_id_str</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="n">b</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_id_str</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">all_regions</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">all_regions</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;last_region_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">all_regions</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>
        <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_meta&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span></div>



<div class="viewcode-block" id="update_regions">
<a class="viewcode-back" href="../../api.html#astromon.db.update_regions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update exclusion regions in the astromon_regions table.</span>

<span class="sd">    Things to keep in mind:</span>

<span class="sd">        - last_modified is updated automatically.</span>
<span class="sd">        - Changes region_id_str are ignored.</span>
<span class="sd">        - Entries that do not differ from the values in the table are not updated</span>
<span class="sd">          (last_modified is not set).</span>
<span class="sd">        - This does not remove regions. Use :any:`remove_regions` for that.</span>

<span class="sd">    Raises an exception if:</span>

<span class="sd">        - the astromon_regions table is not in the dbfile.</span>
<span class="sd">        - any of the region_id in `regions` does not exist in the table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regions: `astropy.table.Table`-compatible</span>
<span class="sd">        This parameter gets converted to an `astropy.table.Table`.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;astromon&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating regions: </span><span class="si">{</span><span class="n">regions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">all_regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">from_idx</span><span class="p">,</span> <span class="n">to_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">all_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">last_modified</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span>
        <span class="k">for</span> <span class="n">to_i</span><span class="p">,</span> <span class="n">from_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">to_idx</span><span class="p">,</span> <span class="n">from_idx</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">all_regions</span><span class="p">[</span><span class="n">to_i</span><span class="p">],</span> <span class="n">regions</span><span class="p">[</span><span class="n">from_i</span><span class="p">]):</span>
                <span class="n">all_regions</span><span class="p">[</span><span class="n">to_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="n">from_i</span><span class="p">]</span>
                <span class="n">all_regions</span><span class="p">[</span><span class="n">to_i</span><span class="p">][</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_modified</span>

        <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">all_regions</span><span class="p">,</span> <span class="n">h5</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">regions</span></div>



<div class="viewcode-block" id="get_regions">
<a class="viewcode-back" href="../../api.html#astromon.db.get_regions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_regions</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get exclusion regions from the astromon_regions table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obsid: int</span>
<span class="sd">        If provided, only return regions with obsid=0 or centered around the nominal pointing</span>
<span class="sd">        of the given obsid, as stored in the obspar file.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    radius: :any:`astropy.units.Quantity`</span>
<span class="sd">        Maximum distance from the nominal pointing of the observation to include a region.</span>
<span class="sd">        Only used if obsid is provided. Default is 5 arcmin.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :any:`astropy.table.Table`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obsid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obspar</span> <span class="o">=</span> <span class="n">get_obspar</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>
        <span class="n">obs_loc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">obspar</span><span class="p">[</span><span class="s2">&quot;ra_nom&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">obspar</span><span class="p">[</span><span class="s2">&quot;dec_nom&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span>
            <span class="p">(</span><span class="n">obs_loc</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obsid</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">regions</span></div>



<div class="viewcode-block" id="sync_regions">
<a class="viewcode-back" href="../../api.html#astromon.db.sync_regions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sync_regions</span><span class="p">(</span><span class="n">from_file</span><span class="p">,</span> <span class="n">to_file</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync exclusion regions from one astromon DB file to another.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    from_file: :any:`pathlib.Path`</span>
<span class="sd">        Source DB file.</span>
<span class="sd">    to_file: :any:`pathlib.Path`</span>
<span class="sd">        Destination DB file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">from_regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">from_file</span><span class="p">)</span>
    <span class="n">to_regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_meta&quot;</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span>
    <span class="c1"># update records that are in both, and last_modified is newer in from_file</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">from_idx</span><span class="p">,</span> <span class="n">to_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
        <span class="n">from_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">from_regions</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">][</span><span class="n">from_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">][</span><span class="n">to_idx</span><span class="p">]</span>
    <span class="n">up_to_idx</span> <span class="o">=</span> <span class="n">to_idx</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
    <span class="n">up_from_idx</span> <span class="o">=</span> <span class="n">from_idx</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">up_to_idx</span><span class="p">,</span> <span class="n">up_from_idx</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">to_regions</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_regions</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
    <span class="c1"># remove records that are in to_file but not in from_file</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">from_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">remove</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">missing</span><span class="p">):</span>
        <span class="n">to_regions</span> <span class="o">=</span> <span class="n">to_regions</span><span class="p">[</span><span class="o">~</span><span class="n">missing</span><span class="p">]</span>
    <span class="c1"># add records that are only in from_file</span>
    <span class="n">new</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">from_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">],</span> <span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;region_id_str&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
        <span class="c1"># make sure that region_id is not repeated</span>
        <span class="c1"># if there are repeated region_ids, assign new ones continuing from last_region_id in meta</span>
        <span class="n">new_regions</span> <span class="o">=</span> <span class="n">from_regions</span><span class="p">[</span><span class="n">new</span><span class="p">]</span>
        <span class="n">repeated_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">new_regions</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">],</span> <span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">repeated_ids</span><span class="p">):</span>
            <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">repeated_ids</span><span class="p">)</span>
            <span class="n">start_id</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;last_region_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">new_regions</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">][</span><span class="n">repeated_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_id</span>
        <span class="n">to_regions</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">to_regions</span><span class="p">,</span> <span class="n">new_regions</span><span class="p">])</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;last_region_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_regions</span><span class="p">[</span><span class="s2">&quot;region_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">to_regions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;region_id&quot;</span><span class="p">)</span>

    <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">to_regions</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="s2">&quot;astromon_meta&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_in_excluded_region">
<a class="viewcode-back" href="../../api.html#astromon.db.is_in_excluded_region">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_in_excluded_region</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a mask to remove x-ray sources that are close to excluded regions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    position: :any:`astropy.coordinates.SkyCoord`</span>
<span class="sd">        Array of :class:`astropy.coordinates.SkyCoord` objects.</span>
<span class="sd">    obsid: array-like</span>
<span class="sd">        Array of OBSIDs corresponding to each position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">squeeze</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obsid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obsid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obsid</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">position</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obsid and position must have the same shape&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_regions&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">jj</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">in_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">obsid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_region</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">obsid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">in_region</span> <span class="o">=</span> <span class="n">in_region</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">in_region</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">set_formats</span><span class="p">(</span><span class="n">dat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets format of columns with float dtype to show 2 decimals, except ra/dec/pileup (4 decimals).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dat: `astropy.table.Table`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fmts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x_ra&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;c_ra&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x_dec&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;c_dec&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pileup&quot;</span><span class="p">:</span> <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">itercols</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">colnames</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span>
        <span class="p">):</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_cross_matches">
<a class="viewcode-back" href="../../api.html#astromon.db.get_cross_matches">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cross_matches</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;astromon_21&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a standard cross-match of observations, x-ray sources and catalog counterparts in `dbfile`.</span>

<span class="sd">    A *standard* cross-match is a pre-computed cross-match between x-ray sources and catalog</span>
<span class="sd">    counterparts. The name of the standard cross-match specifies the algorithm and the set of</span>
<span class="sd">    parameters that have been used to cross-match.</span>

<span class="sd">    If you want a *non-standard* cross-match, with your own set of parameters, refer to the</span>
<span class="sd">    :any:`compute_cross_matches &lt;cross_match.compute_cross_matches&gt;` function.</span>

<span class="sd">    This function returns a :any:`Table &lt;astropy:astropy.table.Table&gt;` indexed by OBSID and adds a</span>
<span class="sd">    few columns on the fly:</span>

<span class="sd">    - time</span>
<span class="sd">    - c_loc</span>
<span class="sd">    - x_loc</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        name of the standard cross-match.</span>
<span class="sd">    dbfile: :any:`pathlib.Path`</span>
<span class="sd">        File where tables are stored.</span>
<span class="sd">        The default is `$ASTROMON_FILE` or `$SKA/data/astromon/astromon.h5`</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        All extra arguments are passed directly to :any:`cross_match.filter_matches`. These are</span>
<span class="sd">        some of the allowed arguments:</span>

<span class="sd">        - snr</span>
<span class="sd">        - dr</span>
<span class="sd">        - r_angle</span>
<span class="sd">        - start</span>
<span class="sd">        - stop</span>
<span class="sd">        - r_angle_grating</span>
<span class="sd">        - near_neighbor_dist</span>
<span class="sd">        - sim_z</span>
<span class="sd">        - exclude_regions</span>
<span class="sd">        - exclude_bad_targets</span>
<span class="sd">        - exclude_categories</span>

<span class="sd">        Other extra arguments can be passed. In these cases, the argument name determines on which</span>
<span class="sd">        column to filter. Each argument is interpreted according to the type of value passed:</span>

<span class="sd">        - list values cause a row to be selected if the value at that row and column is in the list.</span>
<span class="sd">        - other values cause a row to be selected if the value at that row and column is equal to</span>
<span class="sd">          the argument value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :any:`astropy.table.Table`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astromon.cross_match</span><span class="w"> </span><span class="kn">import</span> <span class="n">filter_matches</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_xcorr&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="s2">&quot;select_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
    <span class="n">astromon_cat_src</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_cat_src&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">astromon_xray_src</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_xray_src&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">astromon_obs</span> <span class="o">=</span> <span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;astromon_obs&quot;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>

    <span class="n">astromon_obs</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">observation</span><span class="o">.</span><span class="n">ID_CATEGORY_MAP</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">astromon_obs</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">astromon_cat_src</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s2">&quot;x_id&quot;</span><span class="p">)</span>
    <span class="n">astromon_cat_src</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;y_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;z_angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;c_id&quot;</span><span class="p">,</span> <span class="s2">&quot;c_ra&quot;</span><span class="p">,</span> <span class="s2">&quot;c_dec&quot;</span><span class="p">,</span> <span class="s2">&quot;c_y_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;c_z_angle&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">astromon_xray_src</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;y_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;z_angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;x_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x_ra&quot;</span><span class="p">,</span> <span class="s2">&quot;x_dec&quot;</span><span class="p">,</span> <span class="s2">&quot;x_y_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;x_z_angle&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">astromon_obs</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">])</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">astromon_cat_src</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="s2">&quot;c_id&quot;</span><span class="p">])</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">astromon_xray_src</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">,</span> <span class="s2">&quot;x_id&quot;</span><span class="p">])</span>

    <span class="n">matches</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s2">&quot;date_obs&quot;</span><span class="p">])</span>
    <span class="n">matches</span><span class="p">[</span><span class="s2">&quot;c_loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s2">&quot;c_ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">matches</span><span class="p">[</span><span class="s2">&quot;c_dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">matches</span><span class="p">[</span><span class="s2">&quot;x_loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s2">&quot;x_ra&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">matches</span><span class="p">[</span><span class="s2">&quot;x_dec&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="n">set_formats</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">filter_matches</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">matches</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s2">&quot;obsid&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matches</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2022, Jean Connelly, Tom Aldcroft, Javier Gonzalez.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 9.1.0. &nbsp;
  </p>
</footer>
  </body>
</html>